name: WordPress Integration Tests

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  version-resolution-test:
    name: "Scenario: ${{ matrix.scenario_name }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - scenario_name: "plugin-a-newer"
            plugin_a_version: "2.0.0"
            plugin_b_version: "1.0.0"
            expected_winner: "plugin-a"
            expected_version: "2.0.0"
          - scenario_name: "plugin-b-newer"
            plugin_a_version: "1.0.0"
            plugin_b_version: "2.0.0"
            expected_winner: "plugin-b"
            expected_version: "2.0.0"
          - scenario_name: "same-version"
            plugin_a_version: "1.0.0"
            plugin_b_version: "1.0.0"
            expected_winner: "plugin-a"
            expected_version: "1.0.0"
          - scenario_name: "major-version-diff"
            plugin_a_version: "3.0.0"
            plugin_b_version: "1.0.0"
            expected_winner: "plugin-a"
            expected_version: "3.0.0"
          - scenario_name: "patch-version-diff"
            plugin_a_version: "1.0.0"
            plugin_b_version: "1.0.1"
            expected_winner: "plugin-b"
            expected_version: "1.0.1"

    env:
      WP_ENV_PHP_VERSION: "8.2"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required tools
        run: |
          command -v jq >/dev/null 2>&1 || { echo "ERROR: jq not found"; exit 1; }
          command -v curl >/dev/null 2>&1 || { echo "ERROR: curl not found"; exit 1; }
          command -v docker >/dev/null 2>&1 || { echo "ERROR: docker not found"; exit 1; }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, json
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-8.2-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-8.2-

      - name: Install root dependencies
        run: |
          composer install --prefer-dist --no-interaction --no-progress --no-scripts
          npm ci

      - name: Install scenario fixtures
        run: |
          SCENARIO="${{ matrix.scenario_name }}"
          if [ ! -d ".github/fixtures/scenarios/$SCENARIO" ]; then
            echo "ERROR: Scenario directory not found: .github/fixtures/scenarios/$SCENARIO"
            exit 1
          fi
          cp ".github/fixtures/scenarios/$SCENARIO/plugin-a/composer.json" plugin-a/packages/name-utils/composer.json
          cp ".github/fixtures/scenarios/$SCENARIO/plugin-a/php/functions.php" plugin-a/packages/name-utils/php/functions.php
          cp ".github/fixtures/scenarios/$SCENARIO/plugin-b/composer.json" plugin-b/packages/name-utils/composer.json
          cp ".github/fixtures/scenarios/$SCENARIO/plugin-b/php/functions.php" plugin-b/packages/name-utils/php/functions.php

      - name: Verify fixture versions
        run: |
          PLUGIN_A_VERSION=$(jq -r '.version' plugin-a/packages/name-utils/composer.json)
          PLUGIN_B_VERSION=$(jq -r '.version' plugin-b/packages/name-utils/composer.json)
          if [ "$PLUGIN_A_VERSION" != "${{ matrix.plugin_a_version }}" ] || [ "$PLUGIN_B_VERSION" != "${{ matrix.plugin_b_version }}" ]; then
            echo "ERROR: Version mismatch"
            exit 1
          fi

      - name: Setup autoloader-coordinator
        run: |
          rm -rf plugin-a/packages/autoloader-coordinator
          rm -rf plugin-b/packages/autoloader-coordinator
          cp -r packages/autoloader-coordinator plugin-a/packages/autoloader-coordinator
          cp -r packages/autoloader-coordinator plugin-b/packages/autoloader-coordinator

      - name: Install plugin dependencies
        run: |
          set -e
          cd plugin-a && composer install --no-interaction --no-progress --no-scripts
          composer dump-autoload --no-interaction --optimize
          cd ../plugin-b && composer install --no-interaction --no-progress --no-scripts
          composer dump-autoload --no-interaction --optimize
          cd ..
          if ! grep -q "functions.php" plugin-a/vendor/composer/autoload_files.php || ! grep -q "functions.php" plugin-b/vendor/composer/autoload_files.php; then
            echo "ERROR: functions.php not in autoload files"
            exit 1
          fi

      - name: Start wp-env
        run: |
          npx --yes @wordpress/env start --update

      - name: Wait for WordPress readiness
        run: |
          set -e
          MAX_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf http://localhost:8888 >/dev/null 2>&1; then
              if npx --yes @wordpress/env run cli wp core version >/dev/null 2>&1; then
                echo "WordPress is ready"
                exit 0
              fi
            fi
            ATTEMPT=$((ATTEMPT + 1))
            sleep 2
          done
          echo "ERROR: WordPress did not become ready"
          npx --yes @wordpress/env logs
          exit 1

      - name: Verify WordPress response
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888)
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "302" ]; then
            echo "ERROR: WordPress returned HTTP $HTTP_CODE"
            npx --yes @wordpress/env logs
            exit 1
          fi

      - name: Activate plugins
        run: |
          set -e
          npx --yes @wordpress/env run cli wp plugin activate plugin-a plugin-b
          ACTIVE_PLUGINS=$(npx --yes @wordpress/env run cli wp plugin list --status=active --field=name)
          if ! echo "$ACTIVE_PLUGINS" | grep -q "plugin-a" || ! echo "$ACTIVE_PLUGINS" | grep -q "plugin-b"; then
            echo "ERROR: Plugins not activated"
            npx --yes @wordpress/env run cli wp plugin list
            exit 1
          fi

      - name: Verify coordinator class
        run: |
          npx --yes @wordpress/env run cli wp eval "
            if (!class_exists('Blockera\SharedAutoload\Coordinator')) {
              echo 'ERROR: Coordinator class not found';
              exit(1);
            }
            \$coordinator = \Blockera\SharedAutoload\Coordinator::getInstance();
            if (!\$coordinator instanceof \Blockera\SharedAutoload\Coordinator) {
              echo 'ERROR: Coordinator instance invalid';
              exit(1);
            }
            echo 'Coordinator class verified';
          "

      - name: Verify plugin registration
        run: |
          npx --yes @wordpress/env run cli wp eval "
            \$dependencies = apply_filters('blockera/autoloader-coordinator/plugins/dependencies', []);
            if (empty(\$dependencies)) {
              echo 'ERROR: No plugins registered';
              exit(1);
            }
            if (!isset(\$dependencies['plugin-a']) || !isset(\$dependencies['plugin-b'])) {
              echo 'ERROR: Missing plugin registration';
              exit(1);
            }
            echo 'Plugins registered: ' . implode(', ', array_keys(\$dependencies));
          "

      - name: Clear coordinator cache
        run: |
          npx --yes @wordpress/env run cli wp eval "
            delete_transient('blockera_pkgs_files');
            delete_transient('blockera_pkg_manifest');
            echo 'Cache cleared';
          "

      - name: Test version resolution
        id: version-test
        run: |
          set -e
          RAW_OUTPUT=$(npx --yes @wordpress/env run cli wp eval "
            if (!function_exists('blockera_name_utils_get_version')) {
              echo 'ERROR:MISSING_VERSION_FUNCTION';
              exit(1);
            }
            if (!function_exists('blockera_name_utils_get_loaded_from')) {
              echo 'ERROR:MISSING_LOADED_FROM_FUNCTION';
              exit(1);
            }
            \$version = blockera_name_utils_get_version();
            \$loaded_from = blockera_name_utils_get_loaded_from();
            echo \$version . '|' . \$loaded_from;
          " 2>&1)
          
          RESULT=$(echo "$RAW_OUTPUT" | grep -E "(ERROR:|[0-9]+\.[0-9]+\.[0-9]+\|plugin-[ab])" | grep -vE "(Starting|Ran|on the cli|in [0-9]+s)" | head -1 | tr -d '\r\n' | xargs)
          
          if [ -z "$RESULT" ] || echo "$RESULT" | grep -qE "^ERROR:"; then
            echo "ERROR: Helper functions missing"
            echo "Raw output: $RAW_OUTPUT"
            exit 1
          fi
          
          VERSION=$(echo "$RESULT" | cut -d'|' -f1 | xargs)
          LOADED_FROM=$(echo "$RESULT" | cut -d'|' -f2 | xargs)
          
          if [ -z "$VERSION" ] || [ -z "$LOADED_FROM" ]; then
            echo "ERROR: Could not parse result: $RESULT"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "loaded_from=$LOADED_FROM" >> $GITHUB_OUTPUT
          
          if [ "$VERSION" != "${{ matrix.expected_version }}" ] || [ "$LOADED_FROM" != "${{ matrix.expected_winner }}" ]; then
            echo "ERROR: Version resolution failed"
            echo "Expected: ${{ matrix.expected_version }} from ${{ matrix.expected_winner }}"
            echo "Got: $VERSION from $LOADED_FROM"
            exit 1
          fi
          
          echo "Version resolution correct: $VERSION from $LOADED_FROM"

      - name: Verify homepage rendering
        run: |
          set -e
          RESPONSE=$(curl -s http://localhost:8888)
          if echo "$RESPONSE" | grep -qi "fatal error\|parse error\|warning:"; then
            echo "ERROR: PHP errors detected in homepage"
            echo "$RESPONSE" | grep -i "fatal\|parse\|warning" | head -10
            exit 1
          fi

      - name: Display debug info on failure
        if: failure()
        continue-on-error: true
        run: |
          if npx --yes @wordpress/env run cli wp --info >/dev/null 2>&1; then
            npx --yes @wordpress/env logs --no-color 2>&1 | tail -100
            npx --yes @wordpress/env run cli wp eval "
              echo 'Functions:';
              echo '  blockera_name_utils_get_version: ' . (function_exists('blockera_name_utils_get_version') ? 'EXISTS' : 'MISSING');
              echo '  blockera_name_utils_get_loaded_from: ' . (function_exists('blockera_name_utils_get_loaded_from') ? 'EXISTS' : 'MISSING');
            " 2>&1 || true
          fi

      - name: Stop wp-env
        if: always()
        run: npx --yes @wordpress/env stop || true

  wp-compatibility-test:
    name: WordPress ${{ matrix.wp }} - PHP ${{ matrix.php }}
    runs-on: ubuntu-latest
    needs: version-resolution-test

    strategy:
      fail-fast: false
      matrix:
        include:
          - wp: 'latest'
            php: '8.2'
          - wp: 'latest'
            php: '8.1'
          - wp: '6.5'
            php: '8.2'
          - wp: '6.4'
            php: '8.1'
          - wp: '6.3'
            php: '7.4'

    env:
      WP_ENV_PHP_VERSION: ${{ matrix.php }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required tools
        run: |
          command -v jq >/dev/null 2>&1 || { echo "ERROR: jq not found"; exit 1; }
          command -v curl >/dev/null 2>&1 || { echo "ERROR: curl not found"; exit 1; }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, json
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ matrix.php }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-${{ matrix.php }}-

      - name: Install root dependencies
        run: |
          composer install --prefer-dist --no-interaction --no-progress --no-scripts
          npm ci

      - name: Install scenario fixtures
        run: |
          cp ".github/fixtures/scenarios/plugin-a-newer/plugin-a/composer.json" plugin-a/packages/name-utils/composer.json
          cp ".github/fixtures/scenarios/plugin-a-newer/plugin-a/php/functions.php" plugin-a/packages/name-utils/php/functions.php
          cp ".github/fixtures/scenarios/plugin-a-newer/plugin-b/composer.json" plugin-b/packages/name-utils/composer.json
          cp ".github/fixtures/scenarios/plugin-a-newer/plugin-b/php/functions.php" plugin-b/packages/name-utils/php/functions.php

      - name: Setup autoloader-coordinator
        run: |
          rm -rf plugin-a/packages/autoloader-coordinator
          rm -rf plugin-b/packages/autoloader-coordinator
          cp -r packages/autoloader-coordinator plugin-a/packages/autoloader-coordinator
          cp -r packages/autoloader-coordinator plugin-b/packages/autoloader-coordinator

      - name: Install plugin dependencies
        run: |
          set -e
          cd plugin-a && composer install --no-interaction --no-progress --no-scripts
          composer dump-autoload --no-interaction --optimize
          cd ../plugin-b && composer install --no-interaction --no-progress --no-scripts
          composer dump-autoload --no-interaction --optimize
          cd ..

      - name: Update wp-env configuration
        if: matrix.wp != 'latest'
        run: |
          jq --arg wp "${{ matrix.wp }}" '.core = "https://wordpress.org/wordpress-\($wp).zip"' .wp-env.json > .wp-env.json.tmp
          mv .wp-env.json.tmp .wp-env.json

      - name: Start wp-env
        run: |
          npx --yes @wordpress/env start --update

      - name: Wait for WordPress readiness
        run: |
          set -e
          MAX_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf http://localhost:8888 >/dev/null 2>&1; then
              if npx --yes @wordpress/env run cli wp core version >/dev/null 2>&1; then
                echo "WordPress is ready"
                exit 0
              fi
            fi
            ATTEMPT=$((ATTEMPT + 1))
            sleep 2
          done
          echo "ERROR: WordPress did not become ready"
          npx --yes @wordpress/env logs
          exit 1

      - name: Activate plugins
        run: |
          set -e
          npx --yes @wordpress/env run cli wp plugin activate plugin-a plugin-b
          ACTIVE_PLUGINS=$(npx --yes @wordpress/env run cli wp plugin list --status=active --field=name)
          if ! echo "$ACTIVE_PLUGINS" | grep -q "plugin-a" || ! echo "$ACTIVE_PLUGINS" | grep -q "plugin-b"; then
            echo "ERROR: Plugins not activated"
            exit 1
          fi

      - name: Verify coordinator
        run: |
          npx --yes @wordpress/env run cli wp eval "
            if (!class_exists('Blockera\SharedAutoload\Coordinator')) {
              echo 'ERROR: Coordinator class not found';
              exit(1);
            }
            \$coordinator = \Blockera\SharedAutoload\Coordinator::getInstance();
            echo 'Coordinator verified on WordPress ${{ matrix.wp }} + PHP ${{ matrix.php }}';
          "

      - name: Verify version resolution
        run: |
          npx --yes @wordpress/env run cli wp eval "
            if (!function_exists('blockera_name_utils_get_version') || !function_exists('blockera_name_utils_get_loaded_from')) {
              echo 'ERROR: Helper functions missing';
              exit(1);
            }
            \$version = blockera_name_utils_get_version();
            \$loaded_from = blockera_name_utils_get_loaded_from();
            if (\$version !== '2.0.0' || \$loaded_from !== 'plugin-a') {
              echo 'ERROR: Version resolution failed';
              exit(1);
            }
            echo 'Version resolution correct: ' . \$version . ' from ' . \$loaded_from;
          "

      - name: Display debug info on failure
        if: failure()
        continue-on-error: true
        run: |
          if npx --yes @wordpress/env run cli wp --info >/dev/null 2>&1; then
            npx --yes @wordpress/env logs --no-color 2>&1 | tail -50
          fi

      - name: Stop wp-env
        if: always()
        run: npx --yes @wordpress/env stop || true

  pr-comment-on-failure:
    name: Post PR Warning Comment
    runs-on: ubuntu-latest
    needs: [version-resolution-test, wp-compatibility-test]
    if: failure() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Post warning comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const commentBody = `## ‚ö†Ô∏è Autoloader Coordinator - Version Resolution Warning

            The WordPress integration tests have **failed**. This may indicate an issue with how the autoloader-coordinator resolves package versions.

            üîó **[View Full Workflow Run](${runUrl})**

            <sub>This comment was automatically generated by the CI workflow.</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Autoloader Coordinator - Version Resolution Warning')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  pr-comment-on-success:
    name: Post PR Success Comment
    runs-on: ubuntu-latest
    needs: [version-resolution-test, wp-compatibility-test]
    if: success() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write

    steps:
      - name: Post success comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const successBody = `## ‚úÖ Autoloader Coordinator - All Tests Passing

            All WordPress integration tests have **passed successfully**! The autoloader-coordinator is correctly resolving package versions across all scenarios.

            üîó **[View Full Workflow Run](${runUrl})**

            <sub>This comment was automatically generated by the CI workflow.</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const warningComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Autoloader Coordinator - Version Resolution Warning')
            );

            const successComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Autoloader Coordinator - All Tests Passing')
            );

            if (warningComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: warningComment.id,
                body: successBody
              });
            } else if (successComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: successComment.id,
                body: successBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: successBody
              });
            }
