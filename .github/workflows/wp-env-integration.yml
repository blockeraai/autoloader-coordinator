name: WordPress Integration Tests

on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  version-resolution-test:
    name: "Scenario: ${{ matrix.scenario_name }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - scenario_name: "plugin-a-newer"
            plugin_a_version: "2.0.0"
            plugin_b_version: "1.0.0"
            expected_winner: "plugin-a"
            expected_version: "2.0.0"
          - scenario_name: "plugin-b-newer"
            plugin_a_version: "1.0.0"
            plugin_b_version: "2.0.0"
            expected_winner: "plugin-b"
            expected_version: "2.0.0"
          - scenario_name: "same-version"
            plugin_a_version: "1.0.0"
            plugin_b_version: "1.0.0"
            expected_winner: "plugin-a"
            expected_version: "1.0.0"
          - scenario_name: "major-version-diff"
            plugin_a_version: "3.0.0"
            plugin_b_version: "1.0.0"
            expected_winner: "plugin-a"
            expected_version: "3.0.0"
          - scenario_name: "patch-version-diff"
            plugin_a_version: "1.0.0"
            plugin_b_version: "1.0.1"
            expected_winner: "plugin-b"
            expected_version: "1.0.1"

    env:
      WP_ENV_PHP_VERSION: "8.2"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required tools
        run: |
          command -v jq >/dev/null 2>&1 || { echo "ERROR: jq not found"; exit 1; }
          command -v curl >/dev/null 2>&1 || { echo "ERROR: curl not found"; exit 1; }
          command -v docker >/dev/null 2>&1 || { echo "ERROR: docker not found"; exit 1; }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, json
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-8.2-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-8.2-

      - name: Install root dependencies
        run: |
          composer install --prefer-dist --no-interaction --no-progress --no-scripts
          npm ci

      - name: Install scenario fixtures
        run: |
          SCENARIO="${{ matrix.scenario_name }}"
          if [ ! -d ".github/fixtures/scenarios/$SCENARIO" ]; then
            echo "ERROR: Scenario directory not found: .github/fixtures/scenarios/$SCENARIO"
            exit 1
          fi
          cp ".github/fixtures/scenarios/$SCENARIO/plugin-a/composer.json" plugin-a/packages/name-utils/composer.json
          cp ".github/fixtures/scenarios/$SCENARIO/plugin-a/php/functions.php" plugin-a/packages/name-utils/php/functions.php
          cp ".github/fixtures/scenarios/$SCENARIO/plugin-b/composer.json" plugin-b/packages/name-utils/composer.json
          cp ".github/fixtures/scenarios/$SCENARIO/plugin-b/php/functions.php" plugin-b/packages/name-utils/php/functions.php
          # Copy NameFormatter class files if they exist
          if [ -f ".github/fixtures/scenarios/$SCENARIO/plugin-a/php/NameFormatter.php" ]; then
            cp ".github/fixtures/scenarios/$SCENARIO/plugin-a/php/NameFormatter.php" plugin-a/packages/name-utils/php/NameFormatter.php
          fi
          if [ -f ".github/fixtures/scenarios/$SCENARIO/plugin-b/php/NameFormatter.php" ]; then
            cp ".github/fixtures/scenarios/$SCENARIO/plugin-b/php/NameFormatter.php" plugin-b/packages/name-utils/php/NameFormatter.php
          fi

      - name: Verify fixture versions
        run: |
          PLUGIN_A_VERSION=$(jq -r '.version' plugin-a/packages/name-utils/composer.json)
          PLUGIN_B_VERSION=$(jq -r '.version' plugin-b/packages/name-utils/composer.json)
          if [ "$PLUGIN_A_VERSION" != "${{ matrix.plugin_a_version }}" ] || [ "$PLUGIN_B_VERSION" != "${{ matrix.plugin_b_version }}" ]; then
            echo "ERROR: Version mismatch"
            exit 1
          fi

      - name: Setup autoloader-coordinator
        run: |
          rm -rf plugin-a/packages/autoloader-coordinator
          rm -rf plugin-b/packages/autoloader-coordinator
          cp -r packages/autoloader-coordinator plugin-a/packages/autoloader-coordinator
          cp -r packages/autoloader-coordinator plugin-b/packages/autoloader-coordinator

      - name: Install plugin dependencies
        run: |
          set -e
          cd plugin-a && composer install --no-interaction --no-progress --no-scripts
          composer dump-autoload --no-interaction --optimize
          cd ../plugin-b && composer install --no-interaction --no-progress --no-scripts
          composer dump-autoload --no-interaction --optimize
          cd ..
          if ! grep -q "functions.php" plugin-a/vendor/composer/autoload_files.php || ! grep -q "functions.php" plugin-b/vendor/composer/autoload_files.php; then
            echo "ERROR: functions.php not in autoload files"
            exit 1
          fi

      - name: Start wp-env
        run: |
          npx --yes @wordpress/env start --update

      - name: Wait for WordPress readiness
        run: |
          set -e
          MAX_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf http://localhost:8888 >/dev/null 2>&1; then
              if npx --yes @wordpress/env run cli wp core version >/dev/null 2>&1; then
                echo "WordPress is ready"
                exit 0
              fi
            fi
            ATTEMPT=$((ATTEMPT + 1))
            sleep 2
          done
          echo "ERROR: WordPress did not become ready"
          npx --yes @wordpress/env logs
          exit 1

      - name: Verify WordPress response
        run: |
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8888)
          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "302" ]; then
            echo "ERROR: WordPress returned HTTP $HTTP_CODE"
            npx --yes @wordpress/env logs
            exit 1
          fi

      - name: Activate plugins
        run: |
          set -e
          npx --yes @wordpress/env run cli wp plugin activate plugin-a plugin-b
          ACTIVE_PLUGINS=$(npx --yes @wordpress/env run cli wp plugin list --status=active --field=name)
          if ! echo "$ACTIVE_PLUGINS" | grep -q "plugin-a" || ! echo "$ACTIVE_PLUGINS" | grep -q "plugin-b"; then
            echo "ERROR: Plugins not activated"
            npx --yes @wordpress/env run cli wp plugin list
            exit 1
          fi

      - name: Verify coordinator class
        run: |
          npx --yes @wordpress/env run cli wp eval "
            if (!class_exists('Blockera\SharedAutoload\Coordinator')) {
              echo 'ERROR: Coordinator class not found';
              exit(1);
            }
            \$coordinator = \Blockera\SharedAutoload\Coordinator::getInstance();
            if (!\$coordinator instanceof \Blockera\SharedAutoload\Coordinator) {
              echo 'ERROR: Coordinator instance invalid';
              exit(1);
            }
            echo 'Coordinator class verified';
          "

      - name: Verify plugin registration
        run: |
          npx --yes @wordpress/env run cli wp eval "
            \$dependencies = apply_filters('blockera/autoloader-coordinator/plugins/dependencies', []);
            if (empty(\$dependencies)) {
              echo 'ERROR: No plugins registered';
              exit(1);
            }
            if (!isset(\$dependencies['plugin-a']) || !isset(\$dependencies['plugin-b'])) {
              echo 'ERROR: Missing plugin registration';
              exit(1);
            }
            echo 'Plugins registered: ' . implode(', ', array_keys(\$dependencies));
          "

      - name: Clear coordinator cache
        run: |
          npx --yes @wordpress/env run cli wp eval "
            delete_transient('blockera_pkgs_files');
            delete_transient('blockera_pkg_manifest');
            echo 'Cache cleared';
          "

      - name: Test version resolution
        id: version-test
        run: |
          npx --yes @wordpress/env run cli wp eval "
            if (!function_exists('blockera_name_utils_get_version')) {
              echo 'ERROR: blockera_name_utils_get_version function missing';
              exit(1);
            }
            if (!function_exists('blockera_name_utils_get_loaded_from')) {
              echo 'ERROR: blockera_name_utils_get_loaded_from function missing';
              exit(1);
            }
            \$version = blockera_name_utils_get_version();
            \$loaded_from = blockera_name_utils_get_loaded_from();
            \$expected_version = '${{ matrix.expected_version }}';
            \$expected_winner = '${{ matrix.expected_winner }}';
            if (\$version !== \$expected_version || \$loaded_from !== \$expected_winner) {
              echo 'ERROR: Version resolution failed';
              echo 'Expected: ' . \$expected_version . ' from ' . \$expected_winner;
              echo 'Got: ' . \$version . ' from ' . \$loaded_from;
              exit(1);
            }
            echo 'Version resolution correct: ' . \$version . ' from ' . \$loaded_from;
          "

      - name: Test class loading (PSR-4)
        id: class-test
        run: |
          set +e
          CLASS_OUTPUT=$(npx --yes @wordpress/env run cli wp eval "
            if (!class_exists('\\\\Blockera\\\\NameUtils\\\\NameFormatter')) {
              echo 'ERROR:CLASS_NOT_FOUND';
              exit(1);
            }
            \$version = \\Blockera\\NameUtils\\NameFormatter::get_version();
            \$loaded_from = \\Blockera\\NameUtils\\NameFormatter::get_loaded_from();
            echo \$version . '|' . \$loaded_from;
          " 2>&1)
          
          # Extract the actual output (skip wp-env wrapper messages)
          CLASS_RESULT=$(echo "$CLASS_OUTPUT" | grep -E '(version|plugin|ERROR:)' | head -1 | sed 's/^[[:space:]]*//' | tr -d '\r')
          
          if echo "$CLASS_RESULT" | grep -q "ERROR:"; then
            echo "=========================================="
            echo "ERROR: NameFormatter class not found!"
            echo "=========================================="
            echo "Full output:"
            echo "$CLASS_OUTPUT"
            exit 1
          fi
          
          CLASS_VERSION=$(echo "$CLASS_RESULT" | cut -d'|' -f1)
          CLASS_LOADED_FROM=$(echo "$CLASS_RESULT" | cut -d'|' -f2)
          
          EXPECTED_VERSION="${{ matrix.expected_version }}"
          EXPECTED_WINNER="${{ matrix.expected_winner }}"
          
          if [ "$CLASS_VERSION" != "$EXPECTED_VERSION" ]; then
            echo "=========================================="
            echo "ERROR: Class version mismatch"
            echo "Expected: $EXPECTED_VERSION"
            echo "Got: $CLASS_VERSION"
            echo "=========================================="
            exit 1
          fi
          
          if [ "$CLASS_LOADED_FROM" != "$EXPECTED_WINNER" ]; then
            echo "=========================================="
            echo "ERROR: Class loaded from wrong plugin"
            echo "Expected: $EXPECTED_WINNER"
            echo "Got: $CLASS_LOADED_FROM"
            echo "=========================================="
            exit 1
          fi
          
          echo "âœ… Class loading verified: v$CLASS_VERSION from $CLASS_LOADED_FROM"
          set -e

      - name: Verify homepage rendering
        run: |
          set -e
          RESPONSE=$(curl -s http://localhost:8888)
          if echo "$RESPONSE" | grep -qi "fatal error\|parse error\|warning:"; then
            echo "ERROR: PHP errors detected in homepage"
            echo "$RESPONSE" | grep -i "fatal\|parse\|warning" | head -10
            exit 1
          fi

      - name: Display debug info on failure
        if: failure()
        continue-on-error: true
        run: |
          if npx --yes @wordpress/env run cli wp --info >/dev/null 2>&1; then
            npx --yes @wordpress/env logs --no-color 2>&1 | tail -100
            npx --yes @wordpress/env run cli wp eval "
              echo '=== Functions ===';
              echo '  blockera_name_utils_get_version: ' . (function_exists('blockera_name_utils_get_version') ? 'EXISTS' : 'MISSING');
              echo '  blockera_name_utils_get_loaded_from: ' . (function_exists('blockera_name_utils_get_loaded_from') ? 'EXISTS' : 'MISSING');
              echo '';
              echo '=== Classes ===';
              echo '  Blockera\\\\NameUtils\\\\NameFormatter: ' . (class_exists('\\\\Blockera\\\\NameUtils\\\\NameFormatter') ? 'EXISTS' : 'MISSING');
              if (class_exists('\\\\Blockera\\\\NameUtils\\\\NameFormatter')) {
                echo '  Class version: ' . \\Blockera\\NameUtils\\NameFormatter::get_version();
                echo '  Class loaded from: ' . \\Blockera\\NameUtils\\NameFormatter::get_loaded_from();
              }
              echo '';
              echo '=== PSR-4 Autoload ===';
              \$psr4 = require 'plugin-a/vendor/composer/autoload_psr4.php';
              if (isset(\$psr4['Blockera\\\\NameUtils\\\\'])) {
                echo '  Plugin A PSR-4 mapping: ' . implode(', ', \$psr4['Blockera\\\\NameUtils\\\\']);
              }
              \$psr4_b = require 'plugin-b/vendor/composer/autoload_psr4.php';
              if (isset(\$psr4_b['Blockera\\\\NameUtils\\\\'])) {
                echo '  Plugin B PSR-4 mapping: ' . implode(', ', \$psr4_b['Blockera\\\\NameUtils\\\\']);
              }
            " 2>&1 || true
          fi

      - name: Stop wp-env
        if: always()
        run: npx --yes @wordpress/env stop || true

  wp-compatibility-test:
    name: WordPress ${{ matrix.wp }} - PHP ${{ matrix.php }}
    runs-on: ubuntu-latest
    needs: version-resolution-test

    strategy:
      fail-fast: false
      matrix:
        include:
          - wp: 'latest'
            php: '8.2'
          - wp: 'latest'
            php: '8.1'
          - wp: '6.5'
            php: '8.2'
          - wp: '6.4'
            php: '8.1'
          - wp: '6.3'
            php: '7.4'

    env:
      WP_ENV_PHP_VERSION: ${{ matrix.php }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required tools
        run: |
          command -v jq >/dev/null 2>&1 || { echo "ERROR: jq not found"; exit 1; }
          command -v curl >/dev/null 2>&1 || { echo "ERROR: curl not found"; exit 1; }

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mbstring, json
          tools: composer:v2

      - name: Cache Composer dependencies
        uses: actions/cache@v4
        with:
          path: ~/.composer/cache
          key: ${{ runner.os }}-composer-${{ matrix.php }}-${{ hashFiles('**/composer.json') }}
          restore-keys: |
            ${{ runner.os }}-composer-${{ matrix.php }}-

      - name: Install root dependencies
        run: |
          composer install --prefer-dist --no-interaction --no-progress --no-scripts
          npm ci

      - name: Install scenario fixtures
        run: |
          cp ".github/fixtures/scenarios/plugin-a-newer/plugin-a/composer.json" plugin-a/packages/name-utils/composer.json
          cp ".github/fixtures/scenarios/plugin-a-newer/plugin-a/php/functions.php" plugin-a/packages/name-utils/php/functions.php
          cp ".github/fixtures/scenarios/plugin-a-newer/plugin-b/composer.json" plugin-b/packages/name-utils/composer.json
          cp ".github/fixtures/scenarios/plugin-a-newer/plugin-b/php/functions.php" plugin-b/packages/name-utils/php/functions.php

      - name: Setup autoloader-coordinator
        run: |
          rm -rf plugin-a/packages/autoloader-coordinator
          rm -rf plugin-b/packages/autoloader-coordinator
          cp -r packages/autoloader-coordinator plugin-a/packages/autoloader-coordinator
          cp -r packages/autoloader-coordinator plugin-b/packages/autoloader-coordinator

      - name: Install plugin dependencies
        run: |
          set -e
          cd plugin-a && composer install --no-interaction --no-progress --no-scripts
          composer dump-autoload --no-interaction --optimize
          cd ../plugin-b && composer install --no-interaction --no-progress --no-scripts
          composer dump-autoload --no-interaction --optimize
          cd ..

      - name: Update wp-env configuration
        if: matrix.wp != 'latest'
        run: |
          jq --arg wp "${{ matrix.wp }}" '.core = "https://wordpress.org/wordpress-\($wp).zip"' .wp-env.json > .wp-env.json.tmp
          mv .wp-env.json.tmp .wp-env.json

      - name: Start wp-env
        run: |
          npx --yes @wordpress/env start --update

      - name: Wait for WordPress readiness
        run: |
          set -e
          MAX_ATTEMPTS=60
          ATTEMPT=0
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            if curl -sf http://localhost:8888 >/dev/null 2>&1; then
              if npx --yes @wordpress/env run cli wp core version >/dev/null 2>&1; then
                echo "WordPress is ready"
                exit 0
              fi
            fi
            ATTEMPT=$((ATTEMPT + 1))
            sleep 2
          done
          echo "ERROR: WordPress did not become ready"
          npx --yes @wordpress/env logs
          exit 1

      - name: Activate plugins
        run: |
          set -e
          npx --yes @wordpress/env run cli wp plugin activate plugin-a plugin-b
          ACTIVE_PLUGINS=$(npx --yes @wordpress/env run cli wp plugin list --status=active --field=name)
          if ! echo "$ACTIVE_PLUGINS" | grep -q "plugin-a" || ! echo "$ACTIVE_PLUGINS" | grep -q "plugin-b"; then
            echo "ERROR: Plugins not activated"
            exit 1
          fi

      - name: Verify coordinator
        run: |
          npx --yes @wordpress/env run cli wp eval "
            if (!class_exists('Blockera\SharedAutoload\Coordinator')) {
              echo 'ERROR: Coordinator class not found';
              exit(1);
            }
            \$coordinator = \Blockera\SharedAutoload\Coordinator::getInstance();
            echo 'Coordinator verified on WordPress ${{ matrix.wp }} + PHP ${{ matrix.php }}';
          "

      - name: Verify version resolution
        run: |
          npx --yes @wordpress/env run cli wp eval "
            if (!function_exists('blockera_name_utils_get_version') || !function_exists('blockera_name_utils_get_loaded_from')) {
              echo 'ERROR: Helper functions missing';
              exit(1);
            }
            \$version = blockera_name_utils_get_version();
            \$loaded_from = blockera_name_utils_get_loaded_from();
            if (\$version !== '2.0.0' || \$loaded_from !== 'plugin-a') {
              echo 'ERROR: Version resolution failed';
              exit(1);
            }
            echo 'Version resolution correct: ' . \$version . ' from ' . \$loaded_from;
          "

      - name: Display debug info on failure
        if: failure()
        continue-on-error: true
        run: |
          if npx --yes @wordpress/env run cli wp --info >/dev/null 2>&1; then
            npx --yes @wordpress/env logs --no-color 2>&1 | tail -50
          fi

      - name: Stop wp-env
        if: always()
        run: npx --yes @wordpress/env stop || true

  pr-comment-on-failure:
    name: Post PR Warning Comment
    runs-on: ubuntu-latest
    needs: [version-resolution-test, wp-compatibility-test]
    if: failure() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      actions: read

    steps:
      - name: Post warning comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const scenarios = [
              { name: 'plugin-a-newer', pluginA: '2.0.0', pluginB: '1.0.0', winner: 'plugin-a', version: '2.0.0' },
              { name: 'plugin-b-newer', pluginA: '1.0.0', pluginB: '2.0.0', winner: 'plugin-b', version: '2.0.0' },
              { name: 'same-version', pluginA: '1.0.0', pluginB: '1.0.0', winner: 'plugin-a', version: '1.0.0' },
              { name: 'major-version-diff', pluginA: '3.0.0', pluginB: '1.0.0', winner: 'plugin-a', version: '3.0.0' },
              { name: 'patch-version-diff', pluginA: '1.0.0', pluginB: '1.0.1', winner: 'plugin-b', version: '1.0.1' }
            ];
            
            const wpCompatibility = [
              { wp: 'latest', php: '8.2' },
              { wp: 'latest', php: '8.1' },
              { wp: '6.5', php: '8.2' },
              { wp: '6.4', php: '8.1' },
              { wp: '6.3', php: '7.4' }
            ];
            
            const versionResolutionStatus = '${{ needs.version-resolution-test.result }}';
            const wpCompatibilityStatus = '${{ needs.wp-compatibility-test.result }}';
            
            let scenarioTable = '';
            let compatibilityTable = '';
            
            if (versionResolutionStatus === 'failure') {
              scenarioTable = scenarios.map(s => 
                `| **${s.name}** | ${s.pluginA} | ${s.pluginB} | ${s.winner} | âŒ Failed |`
              ).join('\n');
            } else {
              scenarioTable = scenarios.map(s => 
                `| **${s.name}** | ${s.pluginA} | ${s.pluginB} | ${s.winner} | âœ… Pass |`
              ).join('\n');
            }
            
            if (wpCompatibilityStatus === 'failure') {
              compatibilityTable = wpCompatibility.map(c => 
                `| ${c.wp} | ${c.php} | âŒ Failed |`
              ).join('\n');
            } else {
              compatibilityTable = wpCompatibility.map(c => 
                `| ${c.wp} | ${c.php} | âœ… Pass |`
              ).join('\n');
            }
            
            const commentBody = `## âš ï¸ Autoloader Coordinator - Version Resolution Warning

            The WordPress integration tests have **failed**. This may indicate an issue with how the autoloader-coordinator resolves package versions.

            ### ğŸ“Š Test Results Summary

            | Test Suite | Status |
            |------------|--------|
            | Version Resolution Tests | ${versionResolutionStatus === 'failure' ? 'âŒ Failed' : 'âœ… Pass'} |
            | WordPress Compatibility Tests | ${wpCompatibilityStatus === 'failure' ? 'âŒ Failed' : 'âœ… Pass'} |

            ### ğŸ“‹ Version Resolution Test Scenarios

            | Scenario | Plugin A | Plugin B | Expected Winner | Status |
            |----------|----------|----------|-----------------|--------|
            ${scenarioTable}

            ### ğŸ”§ WordPress Compatibility Tests

            | WordPress | PHP | Status |
            |-----------|-----|--------|
            ${compatibilityTable}

            ### ğŸ” Possible Causes

            1. **Version comparison bug** - The coordinator may not be correctly comparing semantic versions
            2. **Loading order issue** - Packages may be loaded before version comparison occurs
            3. **Missing package registration** - A plugin may not be registering its packages correctly
            4. **Default/priority handling** - Same version tie-breaking may not work correctly
            5. **Composer autoload issues** - Autoload files may not be generated correctly
            6. **WordPress/PHP compatibility** - Issues with specific WordPress or PHP versions

            ### ğŸ› ï¸ Debugging Steps

            1. Check the workflow logs for specific error messages
            2. Verify that Composer autoload files are generated correctly
            3. Ensure plugin registration filters are firing correctly
            4. Check if helper functions are available at runtime
            5. Verify WordPress and PHP version compatibility

            ---

            ğŸ”— **[View Full Workflow Run](${runUrl})**

            <sub>This comment was automatically generated by the CI workflow.</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Autoloader Coordinator - Version Resolution Warning')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }

  pr-comment-on-success:
    name: Post PR Success Comment
    runs-on: ubuntu-latest
    needs: [version-resolution-test, wp-compatibility-test]
    if: success() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
      actions: read

    steps:
      - name: Post success comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const scenarios = [
              { name: 'plugin-a-newer', pluginA: '2.0.0', pluginB: '1.0.0', winner: 'plugin-a', version: '2.0.0' },
              { name: 'plugin-b-newer', pluginA: '1.0.0', pluginB: '2.0.0', winner: 'plugin-b', version: '2.0.0' },
              { name: 'same-version', pluginA: '1.0.0', pluginB: '1.0.0', winner: 'plugin-a', version: '1.0.0' },
              { name: 'major-version-diff', pluginA: '3.0.0', pluginB: '1.0.0', winner: 'plugin-a', version: '3.0.0' },
              { name: 'patch-version-diff', pluginA: '1.0.0', pluginB: '1.0.1', winner: 'plugin-b', version: '1.0.1' }
            ];
            
            const wpCompatibility = [
              { wp: 'latest', php: '8.2' },
              { wp: 'latest', php: '8.1' },
              { wp: '6.5', php: '8.2' },
              { wp: '6.4', php: '8.1' },
              { wp: '6.3', php: '7.4' }
            ];
            
            const scenarioTable = scenarios.map(s => 
              `| **${s.name}** | ${s.pluginA} | ${s.pluginB} | ${s.winner} | âœ… Pass |`
            ).join('\n');
            
            const compatibilityTable = wpCompatibility.map(c => 
              `| ${c.wp} | ${c.php} | âœ… Pass |`
            ).join('\n');
            
            const successBody = `## âœ… Autoloader Coordinator - All Tests Passing

            All WordPress integration tests have **passed successfully**! The autoloader-coordinator is correctly resolving package versions across all scenarios.

            ### ğŸ“Š Version Resolution Tests

            All ${scenarios.length} scenarios passed, confirming the coordinator correctly resolves version conflicts:

            | Scenario | Plugin A | Plugin B | Expected Winner | Status |
            |----------|----------|----------|-----------------|--------|
            ${scenarioTable}

            ### ğŸ”§ WordPress Compatibility Tests

            Compatibility verified across ${wpCompatibility.length} WordPress and PHP version combinations:

            | WordPress | PHP | Status |
            |-----------|-----|--------|
            ${compatibilityTable}

            ### âœ… What This Confirms

            - **Semantic version comparison** - Correctly identifies newest version (major.minor.patch)
            - **Version conflict resolution** - Only loads the newest version, preventing conflicts
            - **Default plugin handling** - Correctly handles tie-breaking when versions are identical
            - **Package loading** - Functions and classes from the correct version are available
            - **Cross-version compatibility** - Works across multiple WordPress and PHP versions

            ### ğŸ¯ Test Coverage

            - âœ… Autoloader-coordinator class loading
            - âœ… Plugin registration and discovery
            - âœ… Package manifest generation
            - âœ… Version comparison logic
            - âœ… Package file loading (composer.json, functions.php)
            - âœ… Helper function availability
            - âœ… Homepage rendering without PHP errors
            - âœ… WordPress and PHP version compatibility

            ---

            ğŸ”— **[View Full Workflow Run](${runUrl})**

            <sub>This comment was automatically generated by the CI workflow.</sub>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });

            const warningComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Autoloader Coordinator - Version Resolution Warning')
            );

            const successComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Autoloader Coordinator - All Tests Passing')
            );

            if (warningComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: warningComment.id,
                body: successBody
              });
            } else if (successComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: successComment.id,
                body: successBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: successBody
              });
            }
